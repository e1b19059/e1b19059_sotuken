<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>サンプルプロジェクト</title>
	<link rel="shortcut icon" href="TemplateData/favicon.ico">
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/blockly_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/blocks_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/javascript_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/msg/js/ja.min.js"></script> <!-- 日本語化 -->
	<script src="acorn_interpreter.js"></script>
	<script src="myblock.js"></script>
</head>

<body>
	<button type="button" onclick="unitySendBlockly()">ブロック送信</button>
	<div class="flex">
		<div id="blocklyDiv" style="width: 600px; height: 640px;"></div> <!-- ワークスペースを用意 -->
		<xml id="toolbox" style="display: none">
			<block type="go_left"></block>
			<block type="go_right"></block>
			<block type="go_up"></block>
			<block type="go_down"></block>
			<block type="get_left"></block>
			<block type="get_right"></block>
			<block type="get_up"></block>
			<block type="get_down"></block>
			<block type="check_point"></block>
			<block type="obstacle"></block>
			<block type="controls_if"></block>
			<block type="controls_repeat_ext"></block>
			<block type="logic_compare"></block>
			<block type="math_number"></block>
			<block type="math_arithmetic"></block>
			<block type="text"></block>
			<block type="text_print"></block>
		</xml>
		<canvas class="border border-success" id="unity-canvas"
		style="width: 600px; height: 640px; background: #FFFFFF"></canvas>
	</div>
	<script src="Build/web.loader.js"></script>
	<script>
		var unityInstance = null;
		createUnityInstance(document.querySelector("#unity-canvas"), {
		dataUrl: "Build/web.data",
		frameworkUrl: "Build/web.framework.js",
		codeUrl: "Build/web.wasm",
		streamingAssetsUrl: "StreamingAssets",
		companyName: "DefaultCompany",
		productName: "New Unity Project",
		productVersion: "0.1",
		}).then(x => unityInstance = x);
	</script>
	<script>
		let workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });
		let target_object;
		let data_json;

		document.addEventListener('click', function (e) {
			if (e.target.id == "unity-canvas") {
				// Clicked on canvas 
				unityInstance.SendMessage("Button", "FocusCanvas", "1");
			} else {
				// Clicked outside of canvas 
				unityInstance.SendMessage("Button", "FocusCanvas", "0");
			}
		});
		function unitySendBlockly() {
			let code = Blockly.JavaScript.workspaceToCode(workspace);
			unityInstance.SendMessage("Button", "SetInputFieldText", code);
		}
	
		const initFunc = function (interpreter, scope) {
			let go_left_wrapper = function () {
				return go_left_function();
			};
			let go_right_wrapper = function () {
				return go_right_function();
			};
			let go_up_wrapper = function () {
				return go_up_function();
			};
			let go_down_wrapper = function () {
				return go_down_function();
			};
			let check_wrapper = function (direction, object) {
				return check_point_function(direction, object);
			};
			interpreter.setProperty(scope, 'go_left', interpreter.createNativeFunction(go_left_wrapper));
			interpreter.setProperty(scope, 'go_right', interpreter.createNativeFunction(go_right_wrapper));
			interpreter.setProperty(scope, 'go_up', interpreter.createNativeFunction(go_up_wrapper));
			interpreter.setProperty(scope, 'go_down', interpreter.createNativeFunction(go_down_wrapper));
			interpreter.setProperty(scope, 'check_point', interpreter.createNativeFunction(check_wrapper));
		}

		function go_left_function() {
			unityInstance.SendMessage(target_object, "go_left");
		}
		function go_right_function() {
			unityInstance.SendMessage(target_object, "go_right");
		}
		function go_up_function() {
			unityInstance.SendMessage(target_object, "go_up");
		}
		function go_down_function() {
			unityInstance.SendMessage(target_object, "go_down");
		}
		function check_point_function(direction, object){			
			let check_point;
			let player = data_json.objectData.find(object => object.name == "Circle");
			switch(direction){
				case 'left':
					check_point = {x: player.x - 1, y: player.y};
					break;
				case 'right':
					check_point = {x: player.x + 1, y: player.y};
					break;
				case 'up':
					check_point = {x: player.x, y: player.y - 1};
					break;
				case 'down':
					check_point = {x: player.x, y: player.y + 1};
					break;
			}
			if(data_json.objectData.find(object => object.x == check_point.x && object.y == check_point.y)){
				console.log("true");
				return true;
			}else{
				console.log("false");
				return false;
			}
		}
	</script>
	<style>
		.flex {
			display: flex;
		}
	</style>
</body>

</ht