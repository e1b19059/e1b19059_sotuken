<!DOCTYPE html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>サンプルプロジェクト</title>
	<link rel="shortcut icon" href="TemplateData/favicon.ico">
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/blockly_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/blocks_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/javascript_compressed.min.js"></script> <!-- ライブラリを読み込む -->
	<script src="https://cdn.jsdelivr.net/npm/blockly@1.0.0/msg/js/ja.min.js"></script> <!-- 日本語化 -->
	<script src="acorn_interpreter.js"></script>
	<script src="myblock.js"></script>
</head>

<body>
	<button type="button" onclick="switchWorkspace()">切り替えテスト</button>
	<div class="flex">
		<div class="middle">
			<div id="blocklyDiv" style="width: 650px; height: 640px;"></div> <!-- ワークスペースを用意 -->
			<xml id="toolbox" style="display: none">
				<block type="move_left"></block>
				<block type="move_right"></block>
				<block type="move_forward"></block>
				<block type="move_back"></block>
				<block type="get_left"></block>
				<block type="get_right"></block>
				<block type="get_forward"></block>
				<block type="get_back"></block>
				<block type="check_point"></block>
				<block type="obstacle"></block>
				<block type="controls_if"></block>
				<block type="controls_repeat_ext"></block>
				<block type="logic_compare"></block>
				<block type="math_number"></block>
				<block type="math_arithmetic"></block>
				<block type="text"></block>
				<block type="text_print"></block>
			</xml>
		</div>
		<div id="readOnlyParent" class="bottom">
			<div id="blocklyDiv_readOnly" style="width: 650px; height: 640px;"></div>
		</div>
		<canvas class="border border-success" id="unity-canvas"
		style="width: 600px; height: 640px; background: #FFFFFF; position: absolute; left: 650px"></canvas>
	</div>
	<script src="Build/web.loader.js"></script>
	<script>
		var unityInstance = null;
		createUnityInstance(document.querySelector("#unity-canvas"), {
		dataUrl: "Build/web.data",
		frameworkUrl: "Build/web.framework.js",
		codeUrl: "Build/web.wasm",
		streamingAssetsUrl: "StreamingAssets",
		companyName: "DefaultCompany",
		productName: "New Unity Project",
		productVersion: "0.1",
		}).then(x => unityInstance = x);
	</script>
	<script>
		let workspace = Blockly.inject('blocklyDiv', { toolbox: document.getElementById('toolbox') });
		let workspace_readOnly = Blockly.inject('blocklyDiv_readOnly', { readOnly:true });
		let target_object;
		let data_json;

		function switchWorkspace(){
			let elm = document.getElementById('readOnlyParent');
			if(elm.className == 'bottom'){
				elm.className = 'top';
			}else{
				elm.className = 'bottom';
			}
		}
	
		document.addEventListener('click', function (e) {
			if (e.target.id == "unity-canvas") {
				// Clicked on canvas 
				unityInstance.SendMessage("PhotonLogin", "FocusCanvas", "1");
			} else {
				// Clicked outside of canvas 
				unityInstance.SendMessage("PhotonLogin", "FocusCanvas", "0");
			}
		});

		const initFunc = function (interpreter, scope) {
			let move_left_wrapper = function () {
				return move_left_function();
			};
			let move_right_wrapper = function () {
				return move_right_function();
			};
			let move_forward_wrapper = function () {
				return move_forward_function();
			};
			let move_back_wrapper = function () {
				return move_back_function();
			};
			let check_wrapper = function (direction, object) {
				return check_point_function(direction, object);
			};
			let terminate_wrapper = function () {
				return terminate();
			};
			let initiate_wrapper = function () {
				return initiate();
			};
			interpreter.setProperty(scope, 'move_left', interpreter.createNativeFunction(move_left_wrapper));
			interpreter.setProperty(scope, 'move_right', interpreter.createNativeFunction(move_right_wrapper));
			interpreter.setProperty(scope, 'move_forward', interpreter.createNativeFunction(move_forward_wrapper));
			interpreter.setProperty(scope, 'move_back', interpreter.createNativeFunction(move_back_wrapper));
			interpreter.setProperty(scope, 'check_point', interpreter.createNativeFunction(check_wrapper));
			interpreter.setProperty(scope, 'terminate', interpreter.createNativeFunction(terminate_wrapper));
			interpreter.setProperty(scope, 'initiate', interpreter.createNativeFunction(initiate_wrapper));
		}

		function move_left_function() {
			unityInstance.SendMessage(target_object, "MoveLeft");
		}
		function move_right_function() {
			unityInstance.SendMessage(target_object, "MoveRight");
		}
		function move_forward_function() {
			unityInstance.SendMessage(target_object, "MoveForward");
		}
		function move_back_function() {
			unityInstance.SendMessage(target_object, "MoveBack");
		}
		function check_point_function(direction, object){			
			let check_point;
			let player = data_json.objectData.find(object => object.name == target_object);
			switch(direction){
				case 'left':
					check_point = {x: -player.direction.z + player.position.x, y: 0, z: player.direction.x + player.position.z};
					break;
				case 'right':
					check_point = {x: player.direction.z + player.position.x, y: 0, z: -player.direction.x + player.position.z};
					break;
				case 'forward':
					check_point = {x: player.direction.x + player.position.x, y: 0, z: player.direction.z + player.position.z};
					break;
				case 'back':
					check_point = {x: -player.direction.x + player.position.x, y: 0, z: -player.direction.z + player.position.z};
					break;
			}
			if(data_json.objectData.find(object => object.position.x == check_point.x && object.position.z == check_point.z)){
				return true;
			}else{
				return false;
			}
		}
		function initiate(){
			unityInstance.SendMessage("PhotonLogin", "StartUpdate");
		}
		function terminate(){
			unityInstance.SendMessage("PhotonLogin", "StopUpdate");
		}
	</script>
	<style>
		.flex {
			display: flex;
		}
		.top{
			position: absolute;
			z-index: 2;
		}
		.bottom{
			position: absolute;
			z-index: 0;
		}
		.middle{
			position: absolute;
			z-index: 1;
		}
	</style>
</body>

</html>
